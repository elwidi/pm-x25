<script type="text/javascript" src="<?php echo base_url();?>themes/Limitless/default/assets/js/plugins/visualization/echarts/echarts.js"></script>

<div class="panel panel-white">
    <input type="hidden" id = "project_id"  value = "<?php echo $project_id?>" class="form-control">
    <ul class="nav nav-lg nav-tabs nav-tabs-bottom nav-tabs-toolbar no-margin">
        <li class="active"><a href="#project-overview" data-toggle="tab" aria-expanded="true"><i class="icon-menu7 position-left"></i> Overview</a></li>
        <li class=""><a href="#project-tasks" data-toggle="tab" aria-expanded="false"><i class="icon-task position-left"></i> Tasks</a></li>
        <li class=""><a href="#project-mailstones" data-toggle="tab" aria-expanded="false"><i class="icon-flag8 position-left"></i> Milestones</a></li>
        <li class=""><a href="#project-people" data-toggle="tab" aria-expanded="false"><i class="icon-users2 position-left"></i> People</a></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade active in" id="project-overview">
            <div class="row">
                <div class="col-lg-6">
                    <!-- Basic donut chart -->
                    <div class="panel panel-flat">
                        <div class="panel-heading">
                            <h5 class="panel-title">Task Status</h5>
                            <div class="heading-elements">
                                <ul class="icons-list">
                                    <li><a data-action="collapse"></a></li>
                                    <li><a data-action="reload"></a></li>
                                    <li><a data-action="close"></a></li>
                                </ul>
                            </div>
                        </div>

                        <div class="panel-body">
                            <div class="chart-container has-scroll">
                                <div class="chart has-fixed-height has-minimum-width" id="basic_donut"></div>
                            </div>
                        </div>

                       <!-- <div class="content-group-sm">
                            <p class="text-semibold">Extra small progress bar</p>
                            <div class="progress progress-xs"> <div class="progress-bar progress-bar-info" style="width: 75%"> <span class="sr-only">75% Complete</span> </div></div>
                        </div>-->
                    </div>
                    <!-- /basic donut chart -->
                </div>

                <div class="col-md-6">
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="project-tasks">
            <!-- <div class="table-responsive panel-group panel-group-control panel-group-control-left">
                        <table class="table table-sm text-nowrap">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th class="col-md-2">Assigned To</th>
                                    <th class="col-md-2">Priority</th>
                                    <th class="col-md-2">Due Date</th>
                                    <th class="col-md-2">Progress</th>
                                    <th class="text-center" style="width: 20px;"><i class="icon-arrow-down12"></i></th>
                                </tr>
                            </thead>
                            <tbody>
            <div class = "row m-10">
                <a href="#">
                    <button class = "btn bg-success btn-labeled" id = "add_milestone"><b><i class="icon-plus2"></i></b>Add Milestone</button>
                </a>
            </div> -->
            <div class = "row m-10">
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <button class = "btn bg-success btn-labeled"><b><i class="icon-plus2"></i></b>Add...</button>
                            <!-- <span class="caret"></span> -->
                        </a>

                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a href="#" id = "add_task_list"><i class="icon-folder-plus4"></i> Add Task List</a></li>
                            <li><a href="#" id = "add_task"><i class="icon-file-plus"></i> Add Task</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="row m-10">
                <div class="col-lg-3">
                    <input name="search" placeholder="Filter..." autocomplete="off" class = "form-control">
                </div>
<!--                <button id="btnResetSearch" class = "btn btn-primary"><i class="icon-cross2"></i></button>-->
                <span id="matches"></span>
            </div>


           <div class="panel-body">

                <div class="table-responsive">
                    <table class="table tree-table">
                        <thead>
                        <tr>
                            <th style="width: 80px;">#</th>
                            <th>Items</th>
                            <th style="width: 80px;">Due Date</th>
                            <th style="width: 46px;">Like</th>
                            <th style="width: 46px;"></th>

                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        </tbody>
                    </table>

                    <div class = "text-right"><a id = "prev" class = "hidden"></a><a id = "next">Next</a></div>
                </div>
            </div>
        </div>
            <table id="jqGrid"></table>
            <div id="jqGridPager"></div>

        <div class="tab-pane fade" id="project-mailstones">
            <div class = "row m-10">
                <a href="#">
                    <button class = "btn bg-success btn-labeled" id = "add_milestone"><b><i class="icon-plus2"></i></b>Add Milestone</button>
                </a>
            </div>

            <div class="table-responsive">
                <table class="table text-nowrap datatable-milestone-list">
                    <thead>
                        <tr>
                            <!-- <th style="width: 5px"></th> -->
                            <th style="width: 500px">Milestone</th>
                            <th style="width: 250px">Responsible Person</th>
                            <th style="width: 50px">Company</th>
                            <th>Team</th>
                            <th>Start date</th>
                            <th>End date</th>
                            <th>Category</th>
                            <th style="width: 20px;"><i class="icon-arrow-down12"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

            </div>
        </div>

        <div class="tab-pane fade" id="project-people">
            <div class = "row m-10">
                <a href="#">
                    <button class = "btn bg-success btn-labeled" id = "add_user"><b><i class="icon-plus2"></i></b>Add User</button>
                </a>
            </div>
            <table class="table text-nowrap datatable-people-list">
                <thead>
                <tr>
                    <th>Name</th>
                    <th style="width: 250px">Email</th>
                    <th style="width: 50px">Company</th>
                    <th>Team</th>
                    <th>Start date</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>
</div>

<script type="text/javascript">
    $(function () {
    // $('.tools').hide();
    // Set paths
    // ------------------------------
    var js_base = JS_BASE_URL.replace('index.php','');
    require.config({
        paths: {
            echarts: js_base + '/themes/Limitless/default/assets/js/plugins/visualization/echarts'
        }
    });

    var option = "";
    $.ajax({
        url:  JS_BASE_URL +'/projects/getPeopleInProject/'+<?php echo $project_id?>,
        type : 'GET',
        dataType: 'json',
        async: false,
        success: function(res) {
            if(res.status == 'Success'){
                $.each(res.data, function(i, val) {
                    option += '<option value="'+val.id+'">'+val.name+'</option> ';
                });
            }
        }
    });

    var page = 0;


    // Configuration
    // ------------------------------

    require(
        [
            'echarts',
            'echarts/theme/limitless',
            'echarts/chart/pie',
            'echarts/chart/funnel'
        ],


        // Charts setup
        function (ec, limitless) {


            // Initialize charts
            // ------------------------------

            var basic_donut = ec.init(document.getElementById('basic_donut'), limitless);

            basic_donut_options = {

                // Add title
                title: {
                    text: 'Browser popularity',
                    subtext: 'Open source information',
                    x: 'center'
                },

                // Add legend
                legend: {
                    orient: 'vertical',
                    x: 'left',
                    data: ['Internet Explorer','Opera','Safari','Firefox','Chrome']
                },


                // Enable drag recalculate
                calculable: true,

                // Add series
                series: [
                    {
                        name: 'Browsers',
                        type: 'pie',
                        radius: ['50%', '70%'],
                        center: ['50%', '57.5%'],
                        itemStyle: {
                            normal: {
                                label: {
                                    show: true
                                },
                                labelLine: {
                                    show: true
                                }
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    formatter: '{b}' + '\n\n' + '{c} ({d}%)',
                                    position: 'center',
                                    textStyle: {
                                        fontSize: '17',
                                        fontWeight: '500'
                                    }
                                }
                            }
                        },

                        data: [
                            {value: 335, name: 'Internet Explorer'},
                            {value: 310, name: 'Opera'},
                            {value: 234, name: 'Safari'},
                            {value: 135, name: 'Firefox'},
                            {value: 1548, name: 'Chrome'}
                        ]
                    }
                ]
            };

            basic_donut.setOption(basic_donut_options);


            // Resize charts
            // ------------------------------

            window.onresize = function () {
                setTimeout(function (){
                    basic_donut.resize();
                }, 200);
            }
        }
    );
    $('.popover-show').popover({
            title: 'Assign a User',
            html : true,
            placement: 'bottom',
            content: '<div class="row">  ' +
                                '<div class="col-md-12">' +
                                '<form action="#" id = "z_form">' +
                                '<div class="form-group">' +
                                '<label>Select a User</label>' +
                                '<select name="user_id" id = "new_assignee" data-placeholder="Select milestone" class="select">' +
                                '<option value="">No Milestone</option>'+
                                option +
                                '</select>' +
                                '</div>' +
                                '<input type= "hidden" class = "task_id" name = "task_id">'+
                                '<button type= "button" class = "btn btn-success save">SAVE</button>' +
                                '</form>' +
                                '</div>' +
                                '</div>',
            trigger: 'click'
        }).on('shown.bs.popover', function() {
            $('.select').parents('.popover-content').removeAttr('tabindex');
            $('.select').select2();
            $(".task_id").val($(this).attr('task_id'));
            $('.save').click(function () {
                var isProcessing = false;
                var form = $("#z_form");
                $.ajax({
                    type: "POST",
                    url: JS_BASE_URL +'/projects/updateAssignee',
                    data: form.serialize(),
                    beforeSend: function() {
                        if (isProcessing) {
                            return false;
                        }
                    },
                    success: function( response ) {
                        isProcessing = true;

                        return false;
                        // console.log('response');
                        // window.location.replace(JS_BASE_URL +'/projects/id/11');
                    },
                    complete: function() {
                        isProcessing = false;
                    }
                });
            });
        });
    $('.popover-show').click(function () {
        var task_id = $(this).attr('task_id');
        $('.popover-show').not(this).popover('hide');
    });



    $('#add_task').on('click', function() {
        bootbox.dialog({
                title: "Add Task",
                message: '<div class="row">  ' +
                            '<div class="col-md-12">' +
                            '<form action="#" id = "add_task_form">' +
                            '<div class="form-group">' +
                            '<div class="row">' +
                            '<div class="col-sm-12">' +
                            '<label>Task Name?</label>' +
                            '<input type="text" placeholder="Task name" name = "task_name" class="form-control">' +
                            '<input type="hidden" name = "project_id"  value = "<?php echo $project_id?>" class="form-control">' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '<div class = "row">'+
                            '<div class = "col-md-6">'+
                            '<div class="form-group">' +
                            '<label>Who should do this</label>' +
                            '<select id="country" name="asignee" data-placeholder="Anyone" class="select">' +
                            '<option value="">Anyone</option>' +
                            option +
                            '</select>' +
                            '</div>' +
                            '</div>' +
                            '<div class = "col-md-6">'+
                            '<div class="form-group">' +
                            '<label>Priority</label>' +
                            '<select name="priority" data-placeholder="None" class="select">' +
                            '<option value="">None</option>' +
                            '<option value="High">High</option>' +
                            '<option value="Medium">Medium</option>' +
                            '<option value="Low">Low</option>' +
                            '</select>' +
                            '</div>' +
                            '</div>'+
                            '</div>'+
                            '<ul class="nav nav-lg nav-tabs nav-tabs-bottom nav-tabs-toolbar no-margin">'+
                            '<li class="active"><a href="#dc" data-toggle="tab" aria-expanded="true">Description</a></li>'+
                            '<li class=""><a href="#dt" data-toggle="tab" aria-expanded="false">Dates</a></li>'+
                            '<li class=""><a href="#tl" data-toggle="tab" aria-expanded="false">Task List</a></li>'+
                            '</ul>'+
                            '<div class="tab-content">'+
                            '<div class="tab-pane fade active in" id="dc">'+
                            '<div class="form-group"> '+
                            '<label class = "mt-10">Provide a Description (Optional):</label> '+
                            '<textarea rows="4" name = "description" cols="5" id = "project_description" placeholder="Description..." class="form-control"></textarea> '+
                            '</div>'+
                            '</div>'+
                            '<div class="tab-pane fade" id="dt">'+
                            '<label class = "mt-10">Project Dates (Optional)<br/><small class="text-muted">Adding a start and end date provides your team a useful way to see the duration of this project which helps with planning your tasks and milestones</small></label>'+
                            '<div class="row"> '+
                            '<div class="col-sm-6"> '+
                            '<label>Start Date</label> '+
                            '<div class="input-group"> '+
                            '<span class="input-group-addon"><i class="icon-calendar22"></i></span> '+
                            '<input type="text" class="form-control daterange-single start_date" name = "task_start_date" value="" placeholder="No date"> '+
                            '</div> '+
                            '</div> '+
                            '<div class="col-sm-6"> '+
                            '<label>End Date</label> '+
                            '<div class="input-group"> '+
                            '<span class="input-group-addon"><i class="icon-calendar22"></i></span> '+
                            '<input type="text" class="form-control daterange-single end_date" name = "task_end_date" value="" placeholder="No date"> '+
                            '</div> '+
                            '</div> '+
                            '</div>'+
                            '</div>'+
                            '<div class="tab-pane fade" id="tl">'+
                            '<div class="form-group"> '+
                            '<label class = "mt-10">Which task list is the task belong to?</label> '+
                            '<select id="task_list" name="task_list" data-placeholder="Select task list" class="select company"> '+
                            '<option value="">Select task list</option> '+
                            <?php foreach ($task_list as $key => $value) { ?>
                            '<option value="<?php echo $value->id?>"><?php echo $value->task_list_name?></option> '+
                            <?php }?>
                            '</select> '+
                            '</div>  '+
                            '</div>'+
                            '</div>'+
                            '</form>' +
                            '</div>' +
                            '</div>',
                buttons: {
                    success: {
                        label: "Add Task",
                        className: "btn-success",
                        callback: function () {
                            var form = $('#add_task_form');
                            $.ajax( {
                                type: "POST",
                                url: JS_BASE_URL +'/projects/saveTask',
                                data: form.serialize(),
                                success: function( response ) {
                                    window.location.replace(JS_BASE_URL +'/projects/id/11');
                                }
                            });
                        }
                    }
                }
            }
        );

        $('.select').parents('.bootbox').removeAttr('tabindex');
        $('.select').select2();
        $('#task_list').parents('.bootbox').removeAttr('tabindex');
        $('#task_list').select2();
        // Single picker
        $('.start_date').daterangepicker({
            singleDatePicker: true,
            autoUpdateInput : false
        }, function(ddate) {
            $('.start_date').val(ddate.format('DD-MM-YYYY'));
        });

        $('.end_date').daterangepicker({
            singleDatePicker: true,
            autoUpdateInput : false
        }, function(ddate) {
            $('.end_date').val(ddate.format('DD-MM-YYYY'));
        });
    });

    $('#add_milestone').on('click', function() {
        bootbox.dialog({
                title: "Add Milestone",
                message: '<div class="row"> ' +
                        '<div class="col-md-12">' +
                        '<form action="#" id = "add_milestone_form">' +
                        '<div class="form-group">' +
                        '<div class="row">'+
                        '<div class="col-sm-12">'+
                        '<label>Name the milestone</label> '+
                        '<input type="text" name = "milestone" class="form-control"> '+
                        '<input type="hidden" name = "project_id"  value = "<?php echo $project_id?>" class="form-control">' +
                        '</div> '+
                        '</div> '+
                        '</div>'+
                        '<div class="row">'+
                        '<div class="col-sm-6">'+
                        '<div class="form-group"> '+
                        '<label>Who is responsible?</label> '+
                        '<select id="country" name="asignee" data-placeholder="Anyone" class="select company">'+
                        '<option value="">Anyone</option> '+
                        option +
                        '</select>' +
                        '</div> ' +
                        '</div>' +
                        '<div class="col-sm-6">' +
                        '<label>Due Date</label>' +
                        '<div class="input-group">' +
                        '<span class="input-group-addon"><i class="icon-calendar22"></i></span>' +
                        '<input type="text" id = "due_date" class="form-control daterange-single" name = "milestone_due_date" placeholder="No date">' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<ul class="nav nav-lg nav-tabs nav-tabs-bottom nav-tabs-toolbar no-margin">'+
                        '<li class="active"><a href="#a" data-toggle="tab" aria-expanded="true">Notes</a></li>'+
                        ' <li class=""><a href="#b" data-toggle="tab" aria-expanded="false">Followers</a></li>'+
                        '</ul>'+
                        '<div class="tab-content">'+
                        '<div class="tab-pane fade active in" id="a">'+
                        '<div class="form-group">'+
                        '<label class = "m-10">Provide a Description (Optional):</label> '+
                        '<textarea rows="4" cols="5" name = "description" placeholder="Description..." class="form-control"></textarea>'+
                        '</div>'+
                        '</div>'+
                        '<div class="tab-pane fade" id="b">'+
                        '<div class="form-group">'+
                        '<label class = "m-10">Who can see it?</label>'+
                        '<select data-placeholder="Select user" class="select company" multiple = "multiple">'+
                        '<option value="anyone">Anyone in this project</option>'+
                        '<option value="me">Me</option>'+
                        '</select>'+
                        '</div>'+
                        '</div>'+
                        '</form>' +
                        '</div>' +
                        '</div>',
                buttons: {
                    success: {
                        label: "Add Milestone",
                        className: "btn-success",
                        callback: function () {
                            var form = $('#add_milestone_form');
                            $.ajax({
                                url:  JS_BASE_URL +'/projects/saveMilestone',
                                type : 'POST',
                                dataType: 'json',
                                data: form.serialize(),
                                success: function(res) {
                                    var dbmil = $('.datatable-milestone-list').dataTable();
                                    if(res.status == 'Success'){
                                        dbmil.api().ajax.reload();
                                    }
                                }
                            });

                        }
                    }
                }
            }
        );

        $('.select').parents('.bootbox').removeAttr('tabindex');
        $('.select').select2();
        // Single picker
        $('.daterange-single').daterangepicker({
            singleDatePicker: true,
        });
    });


    $('#add_task_list').on('click', function() {
        bootbox.dialog({
                title: "Add Task List",
                message: '<div class="row">  ' +
                            '<div class="col-md-12">' +
                            '<form action="#" id = "task_list_form">' +
                            '<div class="form-group">' +
                            '<div class="row">' +
                            '<div class="col-sm-12">' +
                            '<label>Name the list of the tasks</label>' +
                            '<input type="text" placeholder="Task List Name" name = "task_list_name" class="form-control">' +
                            '<input type="hidden" name = "project_id"  value = "<?php echo $project_id?>" class="form-control">' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="form-group">' +
                            '<label>Notes (Optional):</label>' +
                            '<textarea rows="4" name = "notes" cols="5" id = "task_list_notes" placeholder="Notes" class="form-control"></textarea>' +
                            '</div>' +
                            '<div class="form-group">' +
                            '<label>Attach Task Lisk to Milestone (Optional)</label>' +
                            '<select name="milestone_id" data-placeholder="Select milestone" class="select">' +
                            '<option value="">No Milestone</option>'+
                            <?php foreach ($milestones as $key => $value) { ?>
                                '<option value="<?php echo $value->id ?>"><?php echo $value->milestone_name ?></option>' +
                            <?php }?>
                            '</select>' +
                            '</div>' +
                            '</form>' +
                            '</div>' +
                            '</div>',
                buttons: {
                    success: {
                        label: "Add Task List",
                        className: "btn-success",
                        callback: function () {
                            var form = $('#task_list_form');
                            $.ajax({
                                url:  JS_BASE_URL +'/projects/saveTaskList',
                                type : 'POST',
                                dataType: 'json',
                                data: form.serialize(),
                                success: function(res) {
                                    console.log(res);
                                    if(res.status == 'Success'){
                                        window.location.replace(JS_BASE_URL +'/projects/all');
                                    }
                                }
                            });

                        }
                    }
                }
            }
        );

        $('.select').parents('.bootbox').removeAttr('tabindex');
        $('.select').select2();

        // Single picker
        $('.daterange-single').daterangepicker({
            singleDatePicker: true,

        });
    });

    $('#add_user').on('click', function() {
        var option = "";
        $.ajax({
            url:  JS_BASE_URL +'/projects/getPeopleNotInProject/'+<?php echo $project_id?>,
            type : 'GET',
            dataType: 'json',
            async: false,
            success: function(res) {
                if(res.status == 'Success'){
                    console.log(res.data);
                    $.each(res.data, function(i, val) {
                        option += '<option value="'+val.id+'">'+val.name+'</option> ';
                    });
                }
            }
        });
        bootbox.dialog({
                title: "Add people to this project",
                message: '<div class="row">  ' +
                            '<div class="col-md-12">' +
                            '<form action="#" id = "task_list_form">' +
                            '<div class="form-group">' +
                            '<input type="hidden" name = "project_id"  value = "<?php echo $project_id?>" class="form-control">' +
                            '<select name="team[]" data-placeholder="Select people" class="select" multiple = "multiple">' +
                            '<option value="">No Milestone</option>'+
                            option +
                            '</select>' +
                            '</div>' +
                            '</form>' +
                            '</div>' +
                            '</div>',
                buttons: {
                    success: {
                        label: "Add people",
                        className: "btn-success",
                        callback: function () {
                            var form = $('#task_list_form');
                            $.ajax({
                                url:  JS_BASE_URL +'/projects/addUser',
                                type : 'POST',
                                dataType: 'json',
                                data: form.serialize(),
                                success: function(res) {
                                    /*if(res.status == 'Success'){
                                        window.location.replace(JS_BASE_URL +'/projects/all');
                                    }*/
                                }
                            });

                        }
                    }
                }
            }
        );

        $('.select').parents('.bootbox').removeAttr('tabindex');
        $('.select').select2();

        // Single picker
        $('.daterange-single').daterangepicker({
            singleDatePicker: true,

        });
    });

});

</script>