<?php

class IssueRisk_model extends CI_Model {

    public function __construct()
    {
        parent::__construct();
    }

    public function setUserId()
    {
        $cookie = base64_decode($_COOKIE['SSOID']);
        $crop = explode('+', $cookie);
        return $crop[0];
    }

    public function getIssueRiskDetail($id){
        $this->db->select('*');
        $this->db->from('pm_issue_risk_register');
        $this->db->where('id', $id);
        $query = $this->db->get();
        $tools = $query->row();
        return $tools;
    }

    private function _get_datatable_issueRisk_query()
    {
       /* $column_search = array("tools_id", "description", "pr_number", "po_number");
        $column_order = array("tools_id", "description", "pr_number", "pr_date", "po_number", "po_date");*/
        $this->db->select('b.project_name, a.*');
        $this->db->from('pm_issue_risk_register a');
        $this->db->join('pm_projects b','a.projects_id = b.id');

        $i = 0;
        /*foreach ($column_search as $item) // loop column
        {
            if($_POST['search']['value']) // if datatable send POST for search
            {
                if($i===0) // first loop
                {
                    $this->db->like($item, $_POST['search']['value']);
                }
                else
                {
                    $this->db->or_like($item, $_POST['search']['value']);
                }
            }
            $i++;
        }

        if(isset($_POST['order'])) // here order processing
        {
            $this->db->order_by($column_order[$_POST['order']['0']['column']], $_POST['order']['0']['dir']);
        }*/

    }

    function get_datatable_issueRisk()
    {
        $this->_get_datatable_issueRisk_query();
        if($_POST['length'] != -1)
            $this->db->limit($_POST['length'], $_POST['start']);
        $query = $this->db->get();
        return $query->result();
    }

    function count_filtered_issueRisk()
    {
        $this->_get_datatable_issueRisk_query();
        $query = $this->db->get();
        return $query->num_rows();
    }

    public function count_all_issueRisk()
    {
        $this->db->from("pm_issue_risk_register");
        return $this->db->count_all_results();
    }

    public function saveNewIssueRisk($attc = ""){

        /**
         * ===================================================
         * Transactions with databases
         * ===================================================
         */
        $this->db->trans_begin();

        $raised_date = $this->input->post('raised_date');
        $current_response_date = $this->input->post('current_response_date');
        $further_action_date = $this->input->post('further_action_date');

        if(!empty($raised_date)){
            $raised_date = date('Y-m-d H:i:s', strtotime($this->input->post('raised_date')));
        }
        
        if(!empty($current_response_date)){
            $current_response_date = date('Y-m-d H:i:s', strtotime($this->input->post('current_response_date')));
        }

        if(!empty($further_action_date)){
            $further_action_date = date('Y-m-d H:i:s', strtotime($this->input->post('further_action_date')));
        }


        $data = array(
            'projects_id' => $this->input->post('project_id'),
            'issue_risk' => $this->input->post('issue_risk'),
            'type_of_issue_risk' => $this->input->post('type_of_issue_risk'),
            'raised_date' => $raised_date,
            'status' => $this->input->post('status'),
            'potential_impact' => $this->input->post('potential_impact'),
            'issue_or_risk' => $this->input->post('issue_or_risk'),
            'issue_only' => $this->input->post('issue_only'),
            'risk_only_probability' => $this->input->post('risk_only_probability'),
            'risk_only_impact' => $this->input->post('risk_only_impact'),
            'risk_only_significance' => $this->input->post('risk_only_impact'),
            'current_response' => $this->input->post('current_response'),
            'current_response_date' => $this->input->post('current_response_date'),
            'further_action' => $this->input->post('further_action'),
            'further_action_date' => $this->input->post('further_action_date'),
            'file_attachment' => $attc,
            'created_date' => date('Y-m-d H:i:s'),
            'created_by' => $this->setUserId(),
        );
        $this->db->insert('pm_issue_risk_register', $data);

        /**
         * ===================================================
         * Transactions with databases
         * ===================================================
         */
        if ($this->db->trans_status() === FALSE)
        {
            $this->db->trans_rollback();
        }
        else
        {
            $this->db->trans_commit();
        }

        return true;
    }

    public function updateIssueRisk($attc = ""){
        /**
         * ===================================================
         * Transactions with databases
         * ===================================================
         */
        $this->db->trans_begin();

        $raised_date = $this->input->post('raised_date');
        $current_response_date = $this->input->post('current_response_date');
        $further_action_date = $this->input->post('further_action_date');

        if(!empty($raised_date)){
            $raised_date = date('Y-m-d H:i:s', strtotime($this->input->post('raised_date')));
        }
        
        if(!empty($current_response_date)){
            $current_response_date = date('Y-m-d H:i:s', strtotime($this->input->post('current_response_date')));
        }

        if(!empty($further_action_date)){
            $further_action_date = date('Y-m-d H:i:s', strtotime($this->input->post('further_action_date')));
        }

        $issueId = $this->input->post('issue_id');

        if(!empty($attc)){
            $data = array(
                'projects_id' => $this->input->post('project_id'),
                'issue_risk' => $this->input->post('issue_risk'),
                'type_of_issue_risk' => $this->input->post('type_of_issue_risk'),
                'raised_date' => $raised_date,
                'status' => $this->input->post('status'),
                'potential_impact' => $this->input->post('potential_impact'),
                'issue_or_risk' => $this->input->post('issue_or_risk'),
                'issue_only' => $this->input->post('issue_only'),
                'risk_only_probability' => $this->input->post('risk_only_probability'),
                'risk_only_impact' => $this->input->post('risk_only_impact'),
                'risk_only_significance' => $this->input->post('risk_only_impact'),
                'current_response' => $this->input->post('current_response'),
                'current_response_date' => $this->input->post('current_response_date'),
                'further_action' => $this->input->post('further_action'),
                'further_action_date' => $this->input->post('further_action_date'),
                'created_date' => date('Y-m-d H:i:s'),
                'created_by' => $this->setUserId(),
            );
        } else {
            $data = array(
                'projects_id' => $this->input->post('project_id'),
                'issue_risk' => $this->input->post('issue_risk'),
                'type_of_issue_risk' => $this->input->post('type_of_issue_risk'),
                'raised_date' => $raised_date,
                'status' => $this->input->post('status'),
                'potential_impact' => $this->input->post('potential_impact'),
                'issue_or_risk' => $this->input->post('issue_or_risk'),
                'issue_only' => $this->input->post('issue_only'),
                'risk_only_probability' => $this->input->post('risk_only_probability'),
                'risk_only_impact' => $this->input->post('risk_only_impact'),
                'risk_only_significance' => $this->input->post('risk_only_impact'),
                'current_response' => $this->input->post('current_response'),
                'current_response_date' => $this->input->post('current_response_date'),
                'further_action' => $this->input->post('further_action'),
                'file_attachment' => $attc,
                'last_updated_date' => date('Y-m-d H:i:s'),
                'last_updated_by' => $this->setUserId(),
            );
        }

        
        $this->db->where('id', $issueId);
        $this->db->update('pm_issue_risk_register', $data);

        /**
         * ===================================================
         * Transactions with databases
         * ===================================================
         */
        if ($this->db->trans_status() === FALSE)
        {
            $this->db->trans_rollback();
        }
        else
        {
            $this->db->trans_commit();
        }

        return true;
    }

    public function deleteIssueRisk($id)
    {
        $this->db->delete('pm_issue_risk_register', array('id' => $id));
        return true; 
    }


    public function saveFollowUp($attc = ""){

        /**
         * ===================================================
         * Transactions with databases
         * ===================================================
         */
        $this->db->trans_begin();

        $issueId = $this->input->post('for_issue');
        $follow_up = $this->input->post('follow_up');
        $deleted = explode(",", $this->input->post('deleted_follow_up'));
        foreach ($deleted as $k => $v) {
            $this->db->delete('pm_issue_follow_up', array('id' => $v));
        }
        foreach ($follow_up as $key => $value) {
            $date = $value['date'];
            if(!empty($date)){
                $date = date('Y-m-d', strtotime($date));
            }else {
                $date = null;
            }

            if(empty($attc)){
                $fl = null;
            } else {
                $fl = $attc[$key];
            }

            $data = array(
                'issue_id' => $issueId,
                'follow_up_date' => $date,
                'follow_up_description' => $value['description'],
                'file_attachment' => $fl,
                'created_date' => date('Y-m-d H:i:s'),
                'created_by' => $this->setUserId(),
            );
            // var_dump($data);
            $this->db->insert('pm_issue_follow_up', $data);
        }

        // exit();

        
        /**
         * ===================================================
         * Transactions with databases
         * ===================================================
         */
        if ($this->db->trans_status() === FALSE)
        {
            $this->db->trans_rollback();
        }
        else
        {
            $this->db->trans_commit();
        }

        return true;
    }

    public function getFollowUp($id){
        $this->db->select('*');
        $this->db->from('pm_issue_follow_up');
        $this->db->where('issue_id', $id);
        $query = $this->db->get();
        $follow_up = $query->result();
        return $follow_up;
    }
}