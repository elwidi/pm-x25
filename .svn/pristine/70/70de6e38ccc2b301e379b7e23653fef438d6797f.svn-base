<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Administration extends CI_Controller {

    /**
     * Index Page for this controller.
     *
     * Maps to the following URL
     * 		http://example.com/index.php/welcome
     *	- or -
     * 		http://example.com/index.php/welcome/index
     *	- or -
     * Since this controller is set as the default controller in
     * config/routes.php, it's displayed at http://example.com/
     *
     * So any other public methods not prefixed with an underscore will
     * map to /index.php/welcome/<method_name>
     * @see https://codeigniter.com/user_guide/general/urls.html
     */
    public function __construct()
    {
        parent::__construct();
        $this->load->model('Administrat');
        //$this->load->model('Administration_model', 'm_admin');
    }

    public function index()
    {
        // Get Apps Config
        //$data = $this->apps->info();
        //$data['menu'] = $this->apps->menu();
        $this->allUsers();
//        $this->load->view('dashboard/dashboard_view');
    }

    public function allUsers(){
        $data = $this->apps->info();
        $user = new Administration_model();
        $json = file_get_contents('http://morahrd.moratelindo.co.id/karyawan/index.php/employeeRestserver/employees');
        $obj = json_decode($json);
        $data["user"] = $obj;
        $data['page_title'] = '<span class="text-semibold">Users</span> - List';
        $data['role'] = $user->getAllRole();

        $this->load->view('projects/list_user', $data);
    }

    public function permission(){
        $data = $this->apps->info();
        $user = new Administration_model();
        $data['menu'] = $user->getAllMenu();
        $data['page_title'] = '<span class="text-semibold">Permission</span> - List';

        $this->load->view('administration/list_permission', $data);
    }

    public function datatablePermission(){
        $user = new Administration_model();
        $list = $user->get_datatable_permission();
        $data = array();
        $no = $_POST['start'];
        foreach ($list as $mta) {
            $no++;
            $row = array();
            $row['no'] = $no;
            foreach ($mta as $key => $value) {
                if (empty($value)){
                    $value = "";
                }
                $row[$key] = $value;

            }
            $data[] = $row;
        }


        $output = array(
            "draw" => $_POST['draw'],
            "recordsTotal" => $user->count_filtered_permission(),
            "recordsFiltered" => $user->count_all_permission(),
            "data" => $data,
        );
        echo json_encode($output); exit;
    }

    public function savePermission()
    {
        $user = new Administration_model();
        if ($user->savePermission()) {
            $data = array('status' => 'Success');
        } else {
            $data = array('status' => 'Failed');
        }

        echo json_encode($data);
        exit();
    }

    public function roles(){
        $data = $this->apps->info();
        $data['page_title'] = '<span class="text-semibold">Role</span> - List';
        $this->load->view('administration/list_role', $data);
    }

    public function rolePermissions($roleId)
    {
        $user = new Administration_model();
        $data = $this->apps->info();
        $data['role'] = $user->getRoleName($roleId);
        $data['page_title'] = '<span class="text-semibold">Role</span> - List';
        $data['menu'] = $user->getMenuWithPermission($roleId);
        $data['dissabled'] = 'disabled="disabled"';
        if($this->apps->check('editUserRole')){
            $data['dissabled'] = '';
        }
        $this->load->view('administration/list_role_permission', $data);
    }

    public function datatableRole(){
        $user = new Administration_model();
        $list = $user->get_datatable_role();
        $data = array();
        $no = $_POST['start'];

        foreach ($list as $mta) {
            $no++;
            $row = array();
            $row['no'] = $no;
            foreach ($mta as $key => $value) {
                if (empty($value)){
                    $value = "";
                }
                $row[$key] = $value;

            }
            $data[] = $row;
        }


        $output = array(
            "draw" => $_POST['draw'],
            "recordsTotal" => $user->count_filtered_permission(),
            "recordsFiltered" => $user->count_all_permission(),
            "data" => $data,
        );
        echo json_encode($output); exit;
    }


    public function datatableRolePermission($roleId)
    {
        $user = new Administration_model();
        $list = $user->get_datatable_role_permission();
        $data = array();
        $no = $_POST['start'];
        $list_role_permission = $user->getPermissionbyRole($roleId);
        foreach ($list as $mta) {
            $id_permission = $mta->id_permission;
            $isHavingPermission = count(array_filter($list_role_permission, function($k) use ($id_permission) {
                return $k->permission_id == $id_permission;
            }));

            $no++;
            $row = array();
            $row['no'] = $no;
            $row['isHavingPermission'] = 0;
            if($isHavingPermission > 0) $row['isHavingPermission'] = 1;
            foreach ($mta as $key => $value) {
                if (empty($value)){
                    $value = "";
                }
                $row[$key] = $value;

            }
            $data[] = $row;
        }


        $output = array(
            "draw" => $_POST['draw'],
            "recordsTotal" => $user->count_filtered_role_permission(),
            "recordsFiltered" => $user->count_all_role_permission(),
            "data" => $data,
        );
        echo json_encode($output); exit;
    }

    public function addUser()
    {
        $user = new Administration_model();
        if ($user->saveUser()) {
            $data = array('status' => 'Success');
        } else {
            $data = array('status' => 'Failed');
        }

        echo json_encode($data);
        exit();

    }

    public function datatableUser()
    {
        $user = new Administration_model();
        $list = $user->get_datatable_user_permission();
        $data = array();
        $no = $_POST['start'];
        foreach ($list as $mta) {
            $no++;
            $row = array();
            $row['no'] = $no;
            foreach ($mta as $key => $value) {
                if (empty($value)){
                    $value = "";
                }
                $row[$key] = $value;

            }
            $data[] = $row;
        }


        $output = array(
            "draw" => $_POST['draw'],
            "recordsTotal" => $user->count_filtered_user_permission(),
            "recordsFiltered" => $user->count_all_user_permission(),
            "data" => $data,
        );
        echo json_encode($output); exit;
    }

    public function updateRolePermission(){
        $user = new Administration_model();
        $allowed = $this->apps->check('editUserRole');
        if($allowed){
            if ($user->saveRolePermission()){
                redirect('administration/rolePermissions/'.$this->input->post('role_id'));
            }
        } else {
            show_404();
        }
    }


}
